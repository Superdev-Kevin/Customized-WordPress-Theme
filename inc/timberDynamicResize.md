# TimberDynamicResize (Flynt Feature)

Adds a new filter to twig to delay the generation of resized images and to generate webp version as well.

## Prerequisites

For this feature to work, you have to be using `Timber` with `Twig` and `Upstatement/Routes` for the custom route to resize the images.

Further more you have to adjust your webserver's configuration. For apache, add the following to your docroots `.htaccess` or the vhost settings:

```apache
# BEGIN Dynamic images
RewriteEngine On
RewriteCond %{REQUEST_URI} ^/app/uploads/dynamic
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ /dynamic-images?src=$1 [L,R]

<IfModule mod_setenvif.c>
  # Vary: Accept for all the requests to jpeg and png
  SetEnvIf Request_URI "\.(jpe?g|png)$" REQUEST_image
</IfModule>

<IfModule mod_rewrite.c>
  RewriteEngine On

  # Check if browser supports WebP images
  RewriteCond %{HTTP_ACCEPT} image/webp

  # Check if WebP replacement image exists
  RewriteCond %{DOCUMENT_ROOT}/$1.webp -f

  # Serve WebP image instead
  RewriteRule (.+)\.(jpe?g|png)$ $1.webp [T=image/webp]
</IfModule>

<IfModule mod_headers.c>
  Header append Vary Accept env=REQUEST_image
</IfModule>

<IfModule mod_mime.c>
  AddType image/webp .webp
</IfModule>
# END Dynamic images
```

## API

This filter is a replacement for the resize filter of Timber. Use it just like you would use Timber's resize:

```twig
{{ image.src | resizeDynamic(500, 300) }}
```

## How does it work?

Instead of generating a resized version of an image, when the filter `resize` is called, the `dynamicResize` filter will only generate a URL for the requested image, and save this request in the database.

When this generated URL is requested by a user (via an http request) and the image does not exist on the disk, the webserver will redirect to the `/dynamic-images` endpoint where the image will be generated and served. The image will only be generated, if a respective entry in the custom database table is found (i.e. the image has been requested before by the server).

In addition to this functionality, all images generated by `dynamicResize` will be stored in a custom subfolder of `/uploads`, with the same structure as the normal uploads folder. This way you can delete all generated images, if needed, or skip those while backing up the site.
